-- DAY 18 OF 100 : As a marketing data analyst, you are asked to evaluate the effectiveness and consistency of each campaign. 
-- For each campaign, identify the three days with the highest conversion rates (conversion rate = conversions / clicks). For each of these days, report:
-- Campaign name and channel
-- Report date
-- Impressions, clicks, conversions, spend
-- Conversion rate (to four decimals)
-- The average conversion rate for the campaign (as a reference)
-- The difference between that day's conversion rate and the campaign's average (to highlight outliers)


CREATE TABLE marketing_campaigns (
    campaign_id SERIAL PRIMARY KEY,
    campaign_name VARCHAR(100),
    channel VARCHAR(50),
    start_date DATE,
    end_date DATE
);

CREATE TABLE campaign_performance (
    performance_id SERIAL PRIMARY KEY,
    campaign_id INT REFERENCES marketing_campaigns(campaign_id),
    report_date DATE,
    impressions INT,
    clicks INT,
    conversions INT,
    spend DECIMAL(10,2)
);

INSERT INTO marketing_campaigns (campaign_id, campaign_name, channel, start_date, end_date) VALUES
(1, 'Holiday Blast', 'Email', '2025-07-01', '2025-07-31'),
(2, 'Summer Splash', 'Social Media', '2025-07-05', '2025-07-25'),
(3, 'Back to School', 'Search', '2025-07-10', '2025-08-10'),
(4, 'Flash Deals', 'Display', '2025-07-15', '2025-07-30'),
(5, 'VIP Offers', 'Influencer', '2025-07-01', '2025-07-20');

INSERT INTO campaign_performance (campaign_id, report_date, impressions, clicks, conversions, spend) VALUES
(1, '2025-07-01', 10209, 796, 238, 97.48),
(1, '2025-07-02', 9996, 806, 147, 47.72),
(1, '2025-07-03', 9352, 646, 81, 47.37),
(1, '2025-07-04', 10478, 582, 73, 60.29),
(1, '2025-07-05', 8265, 489, 83, 50.36),
(1, '2025-07-06', 7869, 494, 145, 59.66),
(1, '2025-07-07', 10391, 575, 125, 54.57),
(1, '2025-07-08', 6556, 573, 122, 34.07),
(1, '2025-07-09', 7572, 574, 112, 31.36),
(1, '2025-07-10', 9601, 496, 103, 27.44),
(1, '2025-07-11', 7990, 420, 95, 44.36),
(1, '2025-07-12', 9844, 896, 129, 94.59),
(1, '2025-07-13', 7399, 628, 73, 60.43),
(1, '2025-07-14', 7474, 531, 117, 32.21),
(1, '2025-07-15', 7524, 743, 109, 62.54),
(1, '2025-07-16', 9425, 663, 180, 36.47),
(1, '2025-07-17', 8554, 697, 118, 47.71),
(1, '2025-07-18', 7380, 526, 81, 65.27),
(1, '2025-07-19', 10081, 850, 196, 111.63),
(1, '2025-07-20', 7446, 707, 193, 63.17),
(1, '2025-07-21', 10413, 822, 220, 97.20),
(1, '2025-07-22', 11205, 901, 225, 99.75),
(1, '2025-07-23', 10876, 877, 210, 95.50),
(1, '2025-07-24', 10123, 812, 200, 90.40),
(1, '2025-07-25', 9876, 780, 198, 88.90),
(1, '2025-07-26', 10500, 845, 215, 98.30),
(1, '2025-07-27', 11000, 900, 230, 105.00),
(1, '2025-07-28', 11500, 950, 235, 110.00),
(1, '2025-07-29', 12000, 970, 240, 112.00),
(1, '2025-07-30', 11800, 960, 238, 111.00),
(1, '2025-07-31', 11600, 940, 236, 109.00),
(2, '2025-07-05', 9000, 700, 150, 80.00),
(2, '2025-07-06', 8700, 680, 145, 77.50),
(2, '2025-07-07', 9100, 690, 148, 81.00),
(2, '2025-07-08', 8800, 670, 140, 76.00),
(2, '2025-07-09', 9200, 720, 155, 82.00),
(2, '2025-07-10', 9300, 730, 160, 84.00),
(2, '2025-07-11', 9400, 740, 162, 85.00),
(2, '2025-07-12', 9500, 750, 165, 87.00),
(2, '2025-07-13', 9600, 760, 168, 88.00),
(2, '2025-07-14', 9700, 770, 170, 89.00),
(2, '2025-07-15', 9800, 780, 172, 90.00),
(2, '2025-07-16', 9900, 790, 175, 91.00),
(2, '2025-07-17', 10000, 800, 178, 92.00),
(2, '2025-07-18', 10100, 810, 180, 93.00),
(2, '2025-07-19', 10200, 820, 182, 94.00),
(2, '2025-07-20', 10300, 830, 185, 95.00),
(2, '2025-07-21', 10400, 840, 188, 96.00),
(2, '2025-07-22', 10500, 850, 190, 97.00),
(2, '2025-07-23', 10600, 860, 192, 98.00),
(2, '2025-07-24', 10700, 870, 195, 99.00),
(2, '2025-07-25', 10800, 880, 198, 100.00),
(3, '2025-07-10', 12000, 800, 220, 120.00),
(3, '2025-07-11', 12100, 810, 225, 122.00),
(3, '2025-07-12', 12200, 820, 230, 124.00),
(3, '2025-07-13', 12300, 830, 235, 126.00),
(3, '2025-07-14', 12400, 840, 240, 128.00),
(3, '2025-07-15', 12500, 850, 245, 130.00),
(3, '2025-07-16', 12600, 860, 250, 132.00),
(3, '2025-07-17', 12700, 870, 255, 134.00),
(3, '2025-07-18', 12800, 880, 260, 136.00),
(3, '2025-07-19', 12900, 890, 265, 138.00),
(3, '2025-07-20', 13000, 900, 270, 140.00),
(3, '2025-07-21', 13100, 910, 275, 142.00),
(3, '2025-07-22', 13200, 920, 280, 144.00),
(3, '2025-07-23', 13300, 930, 285, 146.00),
(3, '2025-07-24', 13400, 940, 290, 148.00),
(3, '2025-07-25', 13500, 950, 295, 150.00),
(3, '2025-07-26', 13600, 960, 300, 152.00),
(3, '2025-07-27', 13700, 970, 305, 154.00),
(3, '2025-07-28', 13800, 980, 310, 156.00),
(3, '2025-07-29', 13900, 990, 315, 158.00),
(3, '2025-07-30', 14000, 1000, 320, 160.00),
(3, '2025-07-31', 14100, 1010, 325, 162.00),
(3, '2025-08-01', 14200, 1020, 330, 164.00),
(3, '2025-08-02', 14300, 1030, 335, 166.00),
(3, '2025-08-03', 14400, 1040, 340, 168.00),
(3, '2025-08-04', 14500, 1050, 345, 170.00),
(3, '2025-08-05', 14600, 1060, 350, 172.00),
(3, '2025-08-06', 14700, 1070, 355, 174.00),
(3, '2025-08-07', 14800, 1080, 360, 176.00),
(3, '2025-08-08', 14900, 1090, 365, 178.00),
(3, '2025-08-09', 15000, 1100, 370, 180.00),
(3, '2025-08-10', 15100, 1110, 375, 182.00),
(4, '2025-07-15', 8000, 600, 120, 70.00),
(4, '2025-07-16', 8200, 610, 122, 71.00),
(4, '2025-07-17', 8400, 620, 124, 72.00),
(4, '2025-07-18', 8600, 630, 126, 73.00),
(4, '2025-07-19', 8800, 640, 128, 74.00),
(4, '2025-07-20', 9000, 650, 130, 75.00),
(4, '2025-07-21', 9200, 660, 132, 76.00),
(4, '2025-07-22', 9400, 670, 134, 77.00),
(4, '2025-07-23', 9600, 680, 136, 78.00),
(4, '2025-07-24', 9800, 690, 138, 79.00),
(4, '2025-07-25', 10000, 700, 140, 80.00),
(4, '2025-07-26', 10200, 710, 142, 81.00),
(4, '2025-07-27', 10400, 720, 144, 82.00),
(4, '2025-07-28', 10600, 730, 146, 83.00),
(4, '2025-07-29', 10800, 740, 148, 84.00),
(4, '2025-07-30', 11000, 750, 150, 85.00),
(5, '2025-07-01', 6000, 400, 80, 40.00),
(5, '2025-07-02', 6100, 410, 82, 41.00),
(5, '2025-07-03', 6200, 420, 84, 42.00),
(5, '2025-07-04', 6300, 430, 86, 43.00),
(5, '2025-07-05', 6400, 440, 88, 44.00),
(5, '2025-07-06', 6500, 450, 90, 45.00),
(5, '2025-07-07', 6600, 460, 92, 46.00),
(5, '2025-07-08', 6700, 470, 94, 47.00),
(5, '2025-07-09', 6800, 480, 96, 48.00),
(5, '2025-07-10', 6900, 490, 98, 49.00),
(5, '2025-07-11', 7000, 500, 100, 50.00),
(5, '2025-07-12', 7100, 510, 102, 51.00),
(5, '2025-07-13', 7200, 520, 104, 52.00),
(5, '2025-07-14', 7300, 530, 106, 53.00),
(5, '2025-07-15', 7400, 540, 108, 54.00),
(5, '2025-07-16', 7500, 550, 110, 55.00),
(5, '2025-07-17', 7600, 560, 112, 56.00),
(5, '2025-07-18', 7700, 570, 114, 57.00),
(5, '2025-07-19', 7800, 580, 116, 58.00),
(5, '2025-07-20', 7900, 590, 118, 59.00);

SELECT * FROM marketing_campaigns;
SELECT * FROM campaign_performance;

WITH
	TABLE_CONV_RATE AS (
		SELECT
			CP.*,
			MC.CAMPAIGN_NAME,
			MC.CHANNEL,
			ROUND(CP.CONVERSIONS::NUMERIC / NULLIF(CP.CLICKS, 0), 4) AS CONVERSION_RATE
		FROM
			CAMPAIGN_PERFORMANCE CP
			JOIN MARKETING_CAMPAIGNS MC ON CP.CAMPAIGN_ID = MC.CAMPAIGN_ID
	),
	AVG_CONV AS (
		SELECT
			CAMPAIGN_ID,
			ROUND(AVG(CONVERSIONS::NUMERIC / NULLIF(CLICKS, 0)), 4) AS AVG_CONVERSION_RATE
		FROM
			CAMPAIGN_PERFORMANCE
		GROUP BY
			CAMPAIGN_ID
	),
	RANKED_DAYS AS (
		SELECT
			TCR.*,
			AC.AVG_CONVERSION_RATE,
			TCR.CONVERSION_RATE - AC.AVG_CONVERSION_RATE AS CONVERSION_RATE_DIFF,
			ROW_NUMBER() OVER (
				PARTITION BY
					TCR.CAMPAIGN_ID
				ORDER BY
					TCR.CONVERSION_RATE DESC,
					REPORT_DATE ASC
			) AS RN
		FROM
			TABLE_CONV_RATE TCR
			JOIN AVG_CONV AC ON TCR.CAMPAIGN_ID = AC.CAMPAIGN_ID
	)
SELECT
	CAMPAIGN_NAME,
	CHANNEL,
	REPORT_DATE,
	IMPRESSIONS,
	CLICKS,
	CONVERSIONS,
	SPEND,
	CONVERSION_RATE,
	AVG_CONVERSION_RATE,
	CONVERSION_RATE_DIFF
FROM
	RANKED_DAYS
WHERE
	RN <= 3
ORDER BY
	CAMPAIGN_NAME,
	RN;




