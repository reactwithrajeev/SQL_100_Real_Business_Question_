-- DAY 30 OF 100 : Which customers are frequently late in paying their EMI?
-- A customer is considered “risky” if they paid more than 2 EMIs late by over 5 days in the last 3 months.

CREATE TABLE loan_payments (
    payment_id SERIAL PRIMARY KEY,
    customer_id INT,
    loan_id INT,
    emi_due_date DATE,
    emi_paid_date DATE,
    emi_amount DECIMAL(10,2)
);

INSERT INTO loan_payments (customer_id, loan_id, emi_due_date, emi_paid_date, emi_amount) VALUES
(301, 401, '2025-05-05', '2025-05-15', 1100.00),
(301, 401, '2025-06-05', '2025-06-12', 1100.00),
(301, 401, '2025-07-05', '2025-07-14', 1100.00),
(302, 402, '2025-05-07', '2025-05-20', 1200.00),
(302, 402, '2025-06-07', '2025-06-18', 1200.00),
(302, 402, '2025-07-07', '2025-07-17', 1200.00),
(302, 402, '2025-07-25', '2025-08-05', 1200.00),
(303, 403, '2025-05-10', '2025-05-22', 1300.00),
(303, 403, '2025-06-10', '2025-06-20', 1300.00),
(303, 403, '2025-07-10', '2025-07-19', 1300.00),
(303, 403, '2025-07-25', '2025-08-08', 1300.00),
(303, 403, '2025-07-30', '2025-08-10', 1300.00),
(304, 404, '2025-05-12', '2025-05-15', 1400.00),
(304, 404, '2025-06-12', '2025-06-18', 1400.00),
(304, 404, '2025-07-12', '2025-07-14', 1400.00),
(305, 405, '2025-05-15', '2025-05-25', 1500.00),
(305, 405, '2025-06-15', '2025-06-22', 1500.00),
(305, 405, '2025-07-15', '2025-07-30', 1500.00),
(305, 405, '2025-07-28', '2025-08-02', 1500.00),
(306, 406, '2025-05-18', '2025-06-01', 1600.00),
(306, 406, '2025-06-18', '2025-07-01', 1600.00),
(306, 406, '2025-07-18', '2025-07-25', 1600.00),
(307, 407, '2025-05-20', '2025-05-26', 1700.00),
(307, 407, '2025-06-20', '2025-06-30', 1700.00),
(307, 407, '2025-07-20', '2025-08-01', 1700.00),
(308, 408, '2025-05-22', '2025-05-23', 1800.00),
(308, 408, '2025-06-22', '2025-07-03', 1800.00),
(308, 408, '2025-07-22', '2025-07-31', 1800.00);

SELECT * FROM loan_payments;

SELECT
CUSTOMER_ID,
COUNT(*) FILTER (WHERE EMI_PAID_DATE > EMI_DUE_DATE AND EMI_PAID_DATE - EMI_DUE_DATE > 5) AS LATE_EMI_PYMT
FROM LOAN_PAYMENTS
WHERE EMI_DUE_DATE >= CURRENT_DATE - INTERVAL '3 MONTHS'
GROUP BY CUSTOMER_ID 
HAVING 
COUNT(*) FILTER (WHERE EMI_PAID_DATE > EMI_DUE_DATE AND EMI_PAID_DATE - EMI_DUE_DATE > 5) > 2;
